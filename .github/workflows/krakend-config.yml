name: KrakenD Config CI/CD

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'krakend-configs/**'
      - '.github/workflows/krakend-config.yml'
  pull_request:
    paths:
      - 'krakend-configs/**'

env:
  KRAKEND_VERSION: '2.6.0'
  VAULT_ADDR: 'https://secrets.krockysphere.com'

jobs:
  validate-settings:
    name: Validate KrakenD Settings
    runs-on: ubuntu-latest
    strategy:
      matrix:
        environment: [dev, prod]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Validate settings.json syntax
        run: |
          jq empty krakend-configs/${{ matrix.environment }}/settings.json
          echo "✓ ${{ matrix.environment }}/settings.json is valid JSON"

      - name: Check required fields
        run: |
          SETTINGS="krakend-configs/${{ matrix.environment }}/settings.json"

          for field in version name timeout port output_encoding; do
            if ! jq -e ".$field" "$SETTINGS" > /dev/null; then
              echo "Error: Missing required field: $field"
              exit 1
            fi
          done

          echo "✓ All required fields present in ${{ matrix.environment }}/settings.json"

  build-and-deploy:
    name: Build & Deploy KrakenD Config
    runs-on: ubuntu-latest
    needs: validate-settings
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    strategy:
      matrix:
        environment: [prod]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Install Vault CLI
        run: |
          wget https://releases.hashicorp.com/vault/1.15.6/vault_1.15.6_linux_amd64.zip
          unzip vault_1.15.6_linux_amd64.zip
          sudo mv vault /usr/local/bin/
          vault version

      - name: Login to Vault with AppRole
        run: |
          # Login using AppRole
          VAULT_TOKEN=$(vault write -field=token auth/approle/login \
            role_id="${{ secrets.VAULT_ROLE_ID }}" \
            secret_id="${{ secrets.VAULT_SECRET_ID }}")
          
          # CRITICAL: Mask token from logs to prevent exposure
          echo "::add-mask::$VAULT_TOKEN"
          echo "VAULT_TOKEN=$VAULT_TOKEN" >> $GITHUB_ENV
          
          if [ -z "$VAULT_TOKEN" ] || [ "$VAULT_TOKEN" = "null" ]; then
            echo "Failed to get Vault token"
            exit 1
          fi
          
          echo "✓ Successfully authenticated to Vault"

      - name: Fetch KrakenD endpoints from Vault
        run: |
          # Fetch endpoints as JSON object (not string)
          vault kv get -format=json secret/krakend/${{ matrix.environment }}/endpoints | \
            jq -r '.data.data.endpoints' > krakend-configs/${{ matrix.environment }}/endpoints.json
          
          # Validate
          jq empty krakend-configs/${{ matrix.environment }}/endpoints.json
          echo "✓ Endpoints fetched and validated"

      - name: Fetch kubeconfig from Vault
        run: |
          # Fetch and decode kubeconfig
          mkdir -p $HOME/.kube
          vault kv get -field=config secret/k8s/kubeconfig | base64 -d > $HOME/.kube/config
          
          echo "✓ Kubeconfig fetched and configured"

      - name: Build configuration
        run: |
          chmod +x krakend-configs/build.sh
          krakend-configs/build.sh ${{ matrix.environment }}

      - name: Validate final configuration
        run: |
          # Use Docker to validate config (no install needed)
          docker run --rm -v $(pwd)/krakend-configs/${{ matrix.environment }}:/etc/krakend \
            devopsfaith/krakend:2.6 check -d -c /etc/krakend/krakend.json
          echo "✓ Final configuration is valid"

      - name: Setup kubectl
        uses: azure/setup-kubectl@v3

      - name: Verify kubectl access
        run: |
          kubectl config current-context
          kubectl get nodes

      - name: Install kubeseal
        run: |
          wget https://github.com/bitnami-labs/sealed-secrets/releases/download/v0.24.0/kubeseal-0.24.0-linux-amd64.tar.gz
          tar -xvzf kubeseal-0.24.0-linux-amd64.tar.gz
          sudo install -m 755 kubeseal /usr/local/bin/kubeseal

      - name: Create and seal secret
        run: |
          # Create regular secret
          kubectl create secret generic krakend-config \
            --from-file=krakend.json=krakend-configs/${{ matrix.environment }}/krakend.json \
            --namespace=krakend-${{ matrix.environment }} \
            --dry-run=client -o yaml > /tmp/krakend-secret.yaml

          # Seal it
          kubeseal -f /tmp/krakend-secret.yaml \
            -w services/krakend-${{ matrix.environment }}/sealed-secret.yaml \
            --namespace=krakend-${{ matrix.environment }}

          echo "✓ Secret sealed"

      - name: Commit sealed secret
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add services/krakend-${{ matrix.environment }}/sealed-secret.yaml
          
          if ! git diff --staged --quiet; then
            git commit -m "Update sealed KrakenD ${{ matrix.environment }} config [skip ci]"
            git push
            echo "✓ Sealed secret committed"
          else
            echo "✓ No changes to sealed secret"
          fi

      - name: Wait for ArgoCD sync
        run: |
          echo "Waiting for ArgoCD to sync..."
          sleep 30
          
          kubectl rollout status deployment/krakend -n krakend-${{ matrix.environment }} --timeout=5m
          echo "✓ KrakenD deployment updated successfully"

      - name: Verify health
        run: |
          kubectl port-forward -n krakend-${{ matrix.environment }} svc/krakend 8080:8080 &
          PF_PID=$!
          sleep 5
          
          if curl -f http://localhost:8080/__health; then
            echo "✓ Health check passed"
          else
            echo "✗ Health check failed"
            exit 1
          fi
          
          kill $PF_PID

      - name: Update Vault with deployment metadata
        if: success()
        run: |
          # Store deployment metadata
          vault kv put secret/krakend/${{ matrix.environment }}/deployment \
            timestamp="$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
            commit="${{ github.sha }}" \
            actor="${{ github.actor }}" \
            run_id="${{ github.run_id }}"

          echo "✓ Deployment metadata stored in Vault"

  validate-dev:
    name: Validate Dev Config (PR only)
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Install Vault CLI
        run: |
          wget https://releases.hashicorp.com/vault/1.15.6/vault_1.15.6_linux_amd64.zip
          unzip vault_1.15.6_linux_amd64.zip
          sudo mv vault /usr/local/bin/

      - name: Login to Vault
        run: |
          VAULT_TOKEN=$(vault write -field=token auth/approle/login \
            role_id="${{ secrets.VAULT_ROLE_ID }}" \
            secret_id="${{ secrets.VAULT_SECRET_ID }}")
          
          # CRITICAL: Mask token from logs
          echo "::add-mask::$VAULT_TOKEN"
          echo "VAULT_TOKEN=$VAULT_TOKEN" >> $GITHUB_ENV

      - name: Fetch dev endpoints from Vault
        run: |
          vault kv get -format=json secret/krakend/dev/endpoints | \
            jq -r '.data.data.endpoints' > krakend-configs/dev/endpoints.json
          jq empty krakend-configs/dev/endpoints.json

      - name: Build and validate dev config
        run: |
          chmod +x krakend-configs/build.sh
          krakend-configs/build.sh dev

      - name: Validate configuration
        run: |
          docker run --rm -v $(pwd)/krakend-configs/dev:/etc/krakend \
            devopsfaith/krakend:2.6 check -d -c /etc/krakend/krakend.json

      - name: Comment PR with validation status
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '✅ KrakenD configuration validation passed!\n\nEndpoints loaded from Vault and validated successfully.'
            })
